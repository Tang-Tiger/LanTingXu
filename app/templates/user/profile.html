{% extends "base.html" %}

{% block body %}

    <div class="jumbotron jumbotron-fluid">
        <div class="container">
            <h3 class="text-info">我的小院</h3>
            <p class="lead">{{ current_user.email }}</p>
        </div>
    </div>

    <div class="container mb-5 pb-5">

    {% if current_user.can('sell') %}
        <div class="row">
            <div class="col">
            <strong>我发布的商品</strong>
            <a href="{{ url_for('.update_goods') }}" class="float-right text-info text-decoration-none"><small>添加 <i class="fas fa-plus"></i></small> </a>
            <hr>
            </div>
        </div>
        {% for item in goods_list %}
        <div class="row mt-2" id="goods_{{ item.id }}">
            <div class="col-3 col-md-2 col-xl-1 pr-2 pt-1">
                <div style="height: 0; padding-top: 100%; background-size: cover; background-position: center; background-image: url('{% if item.img.first() %}{{ url_for('static', filename='img_goods/'+item.img.first().filename_s) }}{% else %}{{ url_for('static', filename='img/no-image.jpg') }}{% endif %}')"></div>
            </div>
            <div class="col px-0 mr-3 border-bottom">
                {{ item.name }}
                <br>
                <small>编号：{{ item.id }} &nbsp; 租金：&yen;{{ item.rent }}</small>
                <br>
                <small class="float-right">
                    <a href="{{ url_for('.update_goods', goods_id=item.id) }}" class="text-info text-decoration-none mr-2">编辑 <i class="fas fa-pen-square"></i> </a>
                    <a href="javascript:void (0);" data-toggle="modal" data-target="#goods-delete-modal" data-goodsid="{{ item.id }}" class="text-danger text-decoration-none">删除 <i class="fas fa-trash"></i> </a>
                </small>
            </div>
        </div>
        {% else %}
        <div class="row mt-2">
            <div class="col">
                这里什么也没有...
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="row">
        <div class="col">敬请期待...</div>
        </div>
    {% endif %}

    </div>
    
    <!-- 商品删除的post请求确认的modal -->
    <div class="modal fade" id="goods-delete-modal" tabindex="-1" role="dialog" aria-labelledby="goods-delete-modal-label" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-info" id="goods-delete-modal-label">提示消息</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            请再次确定是否要删除该商品！
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger delete-goods" data-dismiss="modal">删除</button>
            <button type="button" class="btn btn-info" data-dismiss="modal">取消</button>
          </div>
        </div>
      </div>
    </div>

    {% include "_navbar.html" %}

{% endblock %}

{% block script %}
    <script type="text/javascript">
    
    $('#goods-delete-modal').on('show.bs.modal', function (event) {
        let goods_id = $(event.relatedTarget).data('goodsid');
        $(this).find('.delete-goods').one('click', function () {
            $.ajax({
                url: "{{ url_for('.delete_goods') }}",
                type: "post",
                data: {"goods_id": goods_id},
                beforeSend: showLoading(),
                success: function (data) {
                    $("#goods_"+goods_id.toString()).remove();
                    hideLoading();
                },
                error: function () {
                    showMsg('该商品已被删除。');
                    $("#goods_"+goods_id.toString()).remove();
                    hideLoading();
                }
            })
        });
    });

    </script>
{% endblock %}