{% extends 'base.html' %}

{% block body %}

<div class="jumbotron jumbotron-fluid">
    <div class="container">
        <h3 class="text-info">兰亭集市</h3>
        <p class="lead">兰亭续文创工作室</p>
    </div>
</div>

<div class="container mb-5">

    <div class="row pr-3">
        {% for item in goods_list %}
            <div id="{{ item.id }}" class="col-6 col-md-4 col-xl-3 pr-0">
                <a href="{{ url_for('.goods_show', goods_id=item.id) }}">
                <div data-imageurl="{% if item.img.first() %}{{ url_for('static', filename='img_goods/'+item.img.first().filename_s) }}{% else %}{{ url_for('static', filename='img/no-image.jpg') }}{% endif %}"
                     style="padding-bottom: 100%; height: 0; background-size: cover; background-position: center;" class="rounded img_delay">
                    <span class="badge badge-pill badge-secondary">{{ item.id }}</span>
                </div>
                </a>
                <small class="text-danger">&yen;{{ item.rent }}</small>
                <p class="text-truncate text-dark"><small>{{ item.name }}</small></p>
            </div>
        {% else %}
            <div class="col-6 col-md-4 col-xl-3">
                <p>当前暂无商品图。</p>
            </div>
        {% endfor %}
    </div>

</div>

{% include "_navbar.html" %}

{% endblock %}

{% block script %}
<script type="text/javascript">
// 图片懒加载
$(function () {
    let clock;  // 记录定时任务ID
    let onScroll = function () {
        // 结束上次还未执行的任务
        if (clock) {
            clearTimeout(clock);
        }
        // 建立新的定时任务
        clock = setTimeout(function () {
            // 获取滚动条滚动过的页面的高度
            let scrollTop = $(window).scrollTop();
            // 网页浏览器可视内容部分的高度
            let screenHeight = $(window).height();
            $('.img_delay').each(function (index, element) {
              let $el = $(element);
              // $el.offset().top获取图片距离页面顶部的距离
              // 图片出现在页面可见部分时设置图片的src属性值为data-src属性值
              let elementTop = $el.offset().top;
              let maxHeight = scrollTop + screenHeight;  // 滚动过的高度加上页面高度
              let minHeight = scrollTop - $el.parent().parent().height();  // 滚动过的高度减去图片自身高度
              if (elementTop < maxHeight && elementTop > minHeight && $el.attr('data-imageurl')) {
                $el.attr('style', function(i,origValue){
                    return origValue + "background-image: url('"+$el.attr('data-imageurl')+"');"
                }).removeAttr('data-imageurl');
              }
            });
        }, 300);
    };
    $(window).scroll(onScroll);
    onScroll();
})
</script>
{% endblock %}