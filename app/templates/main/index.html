{% extends 'base.html' %}

{# 设置footer置底的关键代码 #}
{% block html_tag %}class="h-100"{% endblock %}
{% block body_tag %}class="d-flex flex-column h-100"{% endblock %}

{% block body %}
    <main role="main" class="flex-shrink-0">

    <!-- logo部分 -->
    <div class="border-bottom shadow-sm">
    <div class="container">
        <div class="row my-3">
            <div class="col">
                <a href="{{ url_for('.index_new') }}" class="text-decoration-none">
                <img src="{{ url_for('static', filename='img/lantinglogo.gif') }}" width="40rem" height="40rem"><span class="ml-2 align-middle font-weight-bold text-dark">{{ SYS_NAME }}</span>
                </a>
            </div>
        </div>
    </div>
    </div>

    <!-- 主体上半部分 -->
    <div class="container mt-4">

        <!-- 标头caption部分 -->
        <div class="row rounded mx-0" style="height: 15rem; background: url('{{ url_for('static', filename='img/bg-masthead.jpg') }}') no-repeat; background-size: cover;">
            <div class="h-100 w-100 rounded" style="background: rgba(0,0,0,0.4);">
                <div class="row h-100 align-items-center text-white">
                    <div class="col m-2">
                        <p class="h4">{{ body.caption }}</p>
                        <p>{{ body.subhead }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 导航条 -->
        <ul class="nav justify-content-center mt-3">
            {% for item in type_list %}
                <li class="nav-item order-{{ item.sequence }}">
                    <a class="nav-link {% if item.id == type_id %}text-warning  border-bottom border-warning{% else %}text-black-50{% endif %}"
                       href="{{ url_for('.index_new', type_id=item.id) }}">{{ item.name }}</a>
                </li>
            {% endfor %}
        </ul>
    </div>

    <!-- 瀑布流布局内容 -->
    <div class="container mt-4" id="masonry-content">

        <div class="row masonry mr-0"></div>

        <!-- 瀑布流内容加载消息提示部分 -->
        <div class="row">
            <div class="col-12 text-center loading" style="display: none;">
                <div class="spinner-border" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
            </div>
            <div class="col-12 text-center data-null" style="display: none;">
                全部已加载...
            </div>
            <div class="col-12 text-center error-load" style="display: none;">
                加载失败，请刷新页面重试...
            </div>
        </div>
    </div>
    </main>

    <!-- footer部分 -->
    <footer class="mt-auto py-3">
      <div class="container">
        <div class="small text-center text-muted">版权所有 &copy; 2018-2019 - {{ SYS_NAME }}</div>
        <div class="small text-center">
            <a href="http://www.beian.miit.gov.cn/" class="text-muted">蜀ICP备18036635号</a> |
            <a href="{{ url_for('goods_bp.index') }}" class="text-muted">后台管理系统</a>
        </div>
      </div>
    </footer>

{% endblock %}

{% block script %}
    <script type="text/javascript">

    $(function () {
        let data_url;
        let ajax_flg = true;  // 标识是否可以进行ajax请求，如果上一次ajax请求完成了则可以进行下一次的请求了

        // 初始化懒加载
        let lazyLoadInstance = new LazyLoad({elements_selector: ".lazy"});

        // 监听窗口滚动事件 商品数据分页瀑布流
        $(window).scroll(function () {
            if (data_url && ajax_flg && $(document).height() - $(window).height() - $(window).scrollTop() < 200){
                let $loading = $('.loading');
                let $dataNull = $('.data-null');
                let $errorLoad = $('.error-load');
                let $masonry = $('.masonry');
                $.ajax({
                    url: data_url,
                    beforeSend: function () { $loading.show(); ajax_flg = false },
                    success: function (data) {
                        for (let v of data.items) {
                            let $content = $(v);
                            $masonry.masonry({itemSelector: '.masonry-item'}).append($content).masonry('appended', $content);
                        }
                        if (data.items.length > 0) lazyLoadInstance.update();
                        if (!data.next) $dataNull.show();
                        data_url = data.next;
                    },
                    error: () => $errorLoad.show(),
                    complete: function () { $loading.hide(); ajax_flg = true }
                });
            }
        });

        // 监听商品点击事件记录当前页面状态
        $('#masonry-content').on('click', 'a', function () {
            window.sessionStorage.content=$('#masonry-content').html();
            window.sessionStorage.url=data_url;
            window.sessionStorage.scroll=$(window).scrollTop();
        });

        // 加载之前浏览位置
        if (window.sessionStorage.url !== undefined) {
            data_url = window.sessionStorage.url === 'null' ? null : window.sessionStorage.url;
            $('#masonry-content').html(window.sessionStorage.content);
            lazyLoadInstance.update();
            $(window).scrollTop(parseInt(window.sessionStorage.scroll));
            window.sessionStorage.clear();
        } else {
            data_url = '{{ url_for('.goods_list', tid=type_id, page=1) }}';  // 初始化url
            $(window).scroll();
        }
    });

    </script>
{% endblock %}